<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chirpse</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <style>
    body{margin:0;font-family:system-ui;background:#f0f2f5;color:#1c1e21;overflow:hidden;height:100vh}
    #login{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#667ffd,#a855f7,#ff6bcb);color:white;text-align:center}
    #login h1{font-size:60px;margin:0 0 40px}
    input{width:340px;padding:16px;border-radius:12px;border:none;margin:10px;font-size:17px;background:rgba(255,255,255,0.25);color:white;backdrop-filter:blur(10px)}
    input::placeholder{color:rgba(255,255,255,0.8)}
    button{width:340px;padding:16px;border-radius:12px;border:none;margin:10px;font-size:18px;font-weight:600;cursor:pointer}
    #signup-btn{background:white;color:#667ffd}
    #login-btn{background:#1c1e21;color:white}
    #app{display:none;flex-direction:column;height:100vh}
    header{background:#667ffd;color:white;padding:12px;text-align:center;position:fixed;width:100%;top:0;z-index:10}
    nav{display:flex;justify-content:center;gap:20px;margin-top:8px}
    nav a{color:white;text-decoration:none;font-weight:600}
    .container{max-width:500px;margin:70px auto 0;padding:0 16px;overflow-y:auto;flex:1}
    .card{background:white;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    textarea{width:100%;border:none;outline:none;resize:none;font-size:18px;padding:12px 0}
    .post-actions{display:flex;gap:12px;margin-top:10px}
    .btn{background:#e4e6eb;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;flex:1}
    .post{background:white;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .post-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .avatar{width:40px;height:40px;border-radius:50%;background:#ddd}
    .name{font-weight:600}
    .post-img{max-width:100%;border-radius:8px;margin:12px 0}
    .actions{display:flex;gap:12px;margin-top:12px}
    .actions button{background:none;border:none;color:#65676b;cursor:pointer}
    .big-avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto 20px;display:block}
    .profile-center{text-align:center}
    #chat{max-height:60vh;overflow-y:auto;padding:10px;background:#f8f9fa;border-radius:8px;margin:10px 0}
    .msg{padding:10px;border-radius:16px;margin:8px 0;max-width:80%;word-wrap:break-word}
    .me{background:#667ffd;color:white;align-self:flex-end}
    .other{background:#e4e6eb;align-self:flex-start}
    .logout-btn{background:#e4e6eb;color:red;width:100%;margin-top:20px}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login">
    <h1>Chirpse</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="pass" placeholder="Password">
    <button id="signup-btn" onclick="signup()">Sign Up</button>
    <button id="login-btn" onclick="login()">Log In</button>
  </div>

  <!-- APP -->
  <div id="app">
    <header>
      <h2>Chirpse</h2>
      <nav>
        <a onclick="showPage('home')">Home</a>
        <a onclick="showPage('profile')">Profile</a>
        <a onclick="showPage('messages')">Messages</a>
        <a onclick="showPage('settings')">Settings</a>
      </nav>
    </header>

    <!-- HOME FEED -->
    <div id="home" class="container hidden">
      <div class="card">
        <textarea id="postText" placeholder="What's on your mind?"></textarea>
        <div class="post-actions">
          <button class="btn" onclick="document.getElementById('photoInput').click()">Photo</button>
          <button class="btn" onclick="post()">Post</button>
        </div>
        <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="previewPhoto()">
        <img id="photoPreview" class="hidden">
      </div>
      <div id="feed"></div>
    </div>

    <!-- PROFILE -->
    <div id="profile" class="container hidden profile-center">
      <img id="myPic" class="big-avatar" src="https://via.placeholder.com/120/666?text=You">
      <h2 id="myName"></h2>
      <input type="file" id="picInput" accept="image/*" style="display:none" onchange="uploadPic()">
      <button class="btn" onclick="document.getElementById('picInput').click()">Change Photo</button>
      <h3>My Posts</h3>
      <div id="myPosts"></div>
    </div>

    <!-- MESSAGES -->
    <div id="messages" class="container hidden">
      <div class="card">
        <h3>Global Chat</h3>
        <div id="chat"></div>
        <input type="text" id="msgInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMsg()">
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="container hidden">
      <div class="card">
        <h3>Settings</h3>
        <button class="logout-btn" onclick="logout()">Log Out</button>
      </div>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDniXwAIq7jCu3RkZBUnt76tgW5uC1Ld8",
  authDomain: "chirpse-2025.firebaseapp.com",
  projectId: "chirpse-2025",
  storageBucket: "chirpse-2025.appspot.com",
  messagingSenderId: "895121502746",
  appId: "1:895121502746:web:d4cdad596888f7bd7197a3",
  measurementId: "G-M8DE8H44S1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let me = null, myName = "", myPic = "";

auth.onAuthStateChanged(async user => {
  if (user) {
    me = user;
    const snap = await db.collection("users").doc(user.uid).get();
    const data = snap.data() || {};
    myName = data.username || "User";
    myPic = data.photoURL || "https://via.placeholder.com/120/666?text=You";
    document.getElementById("myName").textContent = myName;
    document.getElementById("myPic").src = myPic;
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "flex";
    showPage('home');
    loadFeed();
  } else {
    document.getElementById("app").style.display = "none";
    document.getElementById("login").style.display = "flex";
  }
});

function signup() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;
  const username = document.getElementById("username").value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => db.collection("users").doc(cred.user.uid).set({ username, photoURL: "" }))
    .catch(e => alert(e.message));
}

function login() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function logout() {
  auth.signOut();
}

function showPage(page) {
  document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");
  if (page === "home") loadFeed();
  if (page === "profile") loadMyPosts();
  if (page === "messages") loadChats();
}

function previewPhoto() {
  const file = document.getElementById("photoInput").files[0];
  if (file) {
    document.getElementById("photoPreview").src = URL.createObjectURL(file);
    document.getElementById("photoPreview").classList.remove("hidden");
  }
}

function post() {
  const text = document.getElementById("postText").value;
  const file = document.getElementById("photoInput").files[0];
  if (!text && !file) return;

  const postData = { text, uid: me.uid, name: myName, pic: myPic, timestamp: firebase.firestore.FieldValue.serverTimestamp() };

  if (file) {
    const ref = storage.ref("posts/" + Date.now());
    ref.put(file).then(() => ref.getDownloadURL().then(url => {
      postData.photo = url;
      db.collection("posts").add(postData);
      document.getElementById("postText").value = "";
      document.getElementById("photoInput").value = "";
      document.getElementById("photoPreview").classList.add("hidden");
    }));
  } else {
    db.collection("posts").add(postData);
    document.getElementById("postText").value = "";
  }
}

function loadFeed() {
  db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snap => {
    const feed = document.getElementById("feed");
    feed.innerHTML = "";
    snap.forEach(doc => {
      const p = doc.data();
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<div class="post-header"><div class="avatar" style="background-image:url(${p.pic || 'https://via.placeholder.com/40'})"></div><div class="name">${p.name}</div></div><div>${p.text || ""}</div>${p.photo ? `<img src="${p.photo}" class="post-img">` : ""}`;
      feed.appendChild(div);
    });
  });
}

function loadMyPosts() {
  db.collection("posts").where("uid", "==", me.uid).orderBy("timestamp", "desc").onSnapshot(snap => {
    const container = document.getElementById("myPosts");
    container.innerHTML = "";
    snap.forEach(doc => {
      const p = doc.data();
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<div>${p.text || ""}</div>${p.photo ? `<img src="${p.photo}" class="post-img">` : ""}`;
      container.appendChild(div);
    });
  });
}

function uploadPic() {
  const file = document.getElementById("picInput").files[0];
  if (!file) return;
  const ref = storage.ref("profiles/" + me.uid);
  ref.put(file).then(() => ref.getDownloadURL().then(url => {
    db.collection("users").doc(me.uid).update({ photoURL: url });
    myPic = url;
    document.getElementById("myPic").src = url;
  }));
}

function loadChats() {
  db.collection("messages").orderBy("timestamp", "desc").onSnapshot(snap => {
    const chat = document.getElementById("chat");
    chat.innerHTML = "";
    snap.forEach(doc => {
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "msg " + (m.uid === me.uid ? "me" : "other");
      div.textContent = m.text;
      chat.appendChild(div);
    });
    chat.scrollTop = chat.scrollHeight;
  });
}

function sendMsg() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text) return;
  db.collection("messages").add({ text, uid: me.uid, name: myName, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  input.value = "";
}
</script>
</body>
</html>
